version: '3.3'

networks:
  # ä½¿ç”¨å˜é‡å®šä¹‰ç½‘ç»œåï¼Œç¡®ä¿å¤šé¡¹ç›®éš”ç¦»
  default_net:
    driver: bridge

services:
  # === æœåŠ¡1: SSH éš§é“ (è´Ÿè´£æ‰“æ´) ===
  tunnel:
    image: alpine:latest
    container_name: tunnel_${PROJECT_NAME}
    networks:
      - default_net
    restart: always
    environment:
      SSH_HOST: ${SSH_HOST}
      SSH_PORT: ${SSH_PORT}
      SSH_USER: ${SSH_USER}
      SSH_PASSWORD: ${SSH_PASSWORD}
      REMOTE_DB_PORT: ${REMOTE_DB_PORT}
    volumes:
      # ğŸ”‘ å…±äº«å¯†é’¥: æŒ‚è½½æŒ‡å®šè·¯å¾„çš„ç§é’¥æ–‡ä»¶
      - ../id_rsa/id_rsa_backup:/root/.ssh/id_rsa
    command: >
      sh -c "
      apk add --no-cache openssh-client sshpass &&
      mkdir -p /root/.ssh &&
      chmod 700 /root/.ssh &&
      if [ -s /root/.ssh/id_rsa ]; then
        chmod 600 /root/.ssh/id_rsa
        echo '>>> ä½¿ç”¨ SSH Key è¿æ¥...'
        ssh -o StrictHostKeyChecking=no -N -L 0.0.0.0:3306:127.0.0.1:${REMOTE_DB_PORT} -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST}
      else
        echo '>>> ä½¿ç”¨ SSH å¯†ç è¿æ¥ (Keyä¸ºç©ºæˆ–ä¸å­˜åœ¨)...'
        if [ -z '${SSH_PASSWORD}' ]; then echo 'Error: æ²¡æœ‰æ‰¾åˆ° id_rsa ä¹Ÿæ²¡æœ‰é…ç½® SSH_PASSWORD'; exit 1; fi
        sshpass -p '${SSH_PASSWORD}' ssh -o StrictHostKeyChecking=no -N -L 0.0.0.0:3306:127.0.0.1:${REMOTE_DB_PORT} -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST}
      fi
      "

  # === æœåŠ¡2: æ•°æ®åº“ (é€šè¿‡éš§é“è¿æ¥) ===
  db:
    image: mysql:8.0
    container_name: backup_${PROJECT_NAME}
    networks:
      - default_net
    restart: always
    depends_on:
      - tunnel
    # âš¡ï¸ å¼ºåˆ¶è®¾ç½®å¤‡ä»½åº“ ID ä¸º 100
    # è¿™æ ·ä½ çš„ç”Ÿäº§åº“(Master)å¯ä»¥ç»Ÿä¸€é…ç½®ä¸º 1ï¼Œåªè¦ä¸¤è€…ä¸ä¸€æ ·å³å¯ã€‚
    command: 
      - --default-authentication-plugin=mysql_native_password 
      - --server-id=100             # <--- å¿…é¡»ä¸ä¸»åº“ä¸åŒ
      - --log-bin=mysql-bin        # å¼€å¯ï¼Œç”¨äºè®°å½•ä»åº“è‡ªå·±çš„æ“ä½œ
      - --binlog-format=ROW
      - --gtid-mode=ON             # å¿…é¡»å¼€å¯ï¼Œä¸ä¸»åº“å¯¹é½
      - --enforce-gtid-consistency=ON
      - --read-only=1              # <--- å»ºè®®å¼€å¯ï¼Œé˜²æ­¢è¯¯å†™
      - --log-slave-updates=ON     # å¦‚æœéœ€è¦çº§è”å¤åˆ¶ï¼Œå»ºè®®åŠ ä¸Šæ­¤é¡¹
      - --replicate-do-db=${TARGET_DB_NAME} # <--- åªå¤‡ä»½æŒ‡å®šçš„æ•°æ®åº“
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      # å…³é”®ç‚¹ï¼šè¿™é‡Œè¿æ¥çš„æ˜¯ tunnel æœåŠ¡çš„å®¹å™¨å
      MASTER_HOST: tunnel
      MASTER_PORT: 3306
      MASTER_USER: ${MASTER_USER}
      MASTER_PASSWORD: ${MASTER_PASSWORD}
    ports:
      - "${LOCAL_PORT}:3306"
    volumes:
      - ./data:/var/lib/mysql
      - ./init-slave.sh:/docker-entrypoint-initdb.d/init-slave.sh
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1G

  # === æœåŠ¡3: phpMyAdmin (å¯è§†åŒ–ç®¡ç†) ===
  pma:
    image: phpmyadmin/phpmyadmin
    container_name: pma_${PROJECT_NAME}
    networks:
      - default_net
    restart: always
    environment:
      # å‘Šè¯‰ PMA: æ•°æ®åº“å°±åœ¨éš”å£å®¹å™¨ 'db' çš„ 3306 ç«¯å£ (è¿™æ˜¯å®¹å™¨å†…éƒ¨ç«¯å£ï¼Œæ°¸è¿œæ˜¯ 3306)
      PMA_HOST: db
      PMA_PORT: 3306
    ports:
      # ğŸ”’ å®‰å…¨å‡çº§: æ˜ å°„åˆ°å®¿ä¸»æœºçš„ç«¯å£ (ä» .env è¯»å– PMA_WEB_PORT)
      - "127.0.0.1:${PMA_WEB_PORT}:80"
    depends_on:
      - db

