version: '3.8'

services:
  # === æœåŠ¡1: SSH éš§é“ (è´Ÿè´£æ‰“æ´) ===
  tunnel:
    image: alpine:latest
    container_name: tunnel_${PROJECT_NAME}
    restart: always
    environment:
      SSH_HOST: ${SSH_HOST}
      SSH_PORT: ${SSH_PORT}
      SSH_USER: ${SSH_USER}
      SSH_PASSWORD: ${SSH_PASSWORD}
      REMOTE_DB_PORT: ${REMOTE_DB_PORT}
    volumes:
      # ğŸ”‘ å…±äº«å¯†é’¥: æŒ‚è½½é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ id_rsa (æ‰€æœ‰é¡¹ç›®å…±ç”¨ä¸€æŠŠé’¥åŒ™)
      - ../id_rsa:/root/.ssh/id_rsa:ro
    command: >
      sh -c "
      apk add --no-cache openssh-client sshpass &&
      mkdir -p /root/.ssh &&
      chmod 700 /root/.ssh &&
      if [ -s /root/.ssh/id_rsa ]; then
        chmod 600 /root/.ssh/id_rsa
        echo '>>> ä½¿ç”¨ SSH Key è¿æ¥...'
        ssh -o StrictHostKeyChecking=no -N -L 0.0.0.0:3306:127.0.0.1:${REMOTE_DB_PORT} -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST}
      else
        echo '>>> ä½¿ç”¨ SSH å¯†ç è¿æ¥ (Keyä¸ºç©ºæˆ–ä¸å­˜åœ¨)...'
        if [ -z '${SSH_PASSWORD}' ]; then echo 'Error: æ²¡æœ‰æ‰¾åˆ° id_rsa ä¹Ÿæ²¡æœ‰é…ç½® SSH_PASSWORD'; exit 1; fi
        sshpass -p '${SSH_PASSWORD}' ssh -o StrictHostKeyChecking=no -N -L 0.0.0.0:3306:127.0.0.1:${REMOTE_DB_PORT} -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST}
      fi
      "

  # === æœåŠ¡2: æ•°æ®åº“ (é€šè¿‡éš§é“è¿æ¥) ===
  db:
    image: mysql:8.0
    container_name: backup_${PROJECT_NAME}
    restart: always
    depends_on:
      - tunnel
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      # å…³é”®ç‚¹ï¼šè¿™é‡Œè¿æ¥çš„æ˜¯ tunnel æœåŠ¡çš„å®¹å™¨å
      MASTER_HOST: tunnel
      MASTER_PORT: 3306
      MASTER_USER: ${MASTER_USER}
      MASTER_PASSWORD: ${MASTER_PASSWORD}
    ports:
      - "${LOCAL_PORT}:3306"
    volumes:
      - ./data:/var/lib/mysql
      - ./init-slave.sh:/docker-entrypoint-initdb.d/init-slave.sh
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1G

  # === æœåŠ¡3: phpMyAdmin (å¯è§†åŒ–ç®¡ç†) ===
  pma:
    image: phpmyadmin/phpmyadmin
    container_name: pma_${PROJECT_NAME}
    restart: always
    environment:
      # å‘Šè¯‰ PMA: æ•°æ®åº“å°±åœ¨éš”å£å®¹å™¨ 'db' çš„ 3306 ç«¯å£ (è¿™æ˜¯å®¹å™¨å†…éƒ¨ç«¯å£ï¼Œæ°¸è¿œæ˜¯ 3306)
      PMA_HOST: db
      PMA_PORT: 3306
    ports:
      # ğŸ”’ å®‰å…¨å‡çº§: æ˜ å°„åˆ°å®¿ä¸»æœºçš„ç«¯å£ (ä» .env è¯»å– PMA_WEB_PORT)
      - "127.0.0.1:${PMA_WEB_PORT}:80"
    depends_on:
      - db
