version: '3.8'

services:
  # === 服务1: SSH 隧道 (负责打洞) ===
  tunnel:
    image: alpine:latest
    container_name: tunnel_${PROJECT_NAME}
    restart: always
    environment:
      SSH_HOST: ${SSH_HOST}
      SSH_PORT: ${SSH_PORT}
      SSH_USER: ${SSH_USER}
      SSH_PASSWORD: ${SSH_PASSWORD}
      REMOTE_DB_PORT: ${REMOTE_DB_PORT}
    volumes:
      # 如果有 id_rsa 私钥文件，会自动挂载
      - ./id_rsa:/root/.ssh/id_rsa:ro
    command: >
      sh -c "
      apk add --no-cache openssh-client sshpass &&
      mkdir -p /root/.ssh &&
      chmod 700 /root/.ssh &&
      if [ -s /root/.ssh/id_rsa ]; then
        chmod 600 /root/.ssh/id_rsa
        echo '>>> 使用 SSH Key 连接...'
        ssh -o StrictHostKeyChecking=no -N -L 0.0.0.0:3306:127.0.0.1:${REMOTE_DB_PORT} -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST}
      else
        echo '>>> 使用 SSH 密码连接 (Key为空或不存在)...'
        if [ -z '${SSH_PASSWORD}' ]; then echo 'Error: 没有找到 id_rsa 也没有配置 SSH_PASSWORD'; exit 1; fi
        sshpass -p '${SSH_PASSWORD}' ssh -o StrictHostKeyChecking=no -N -L 0.0.0.0:3306:127.0.0.1:${REMOTE_DB_PORT} -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST}
      fi
      "

  # === 服务2: 数据库 (通过隧道连接) ===
  db:
    image: mysql:8.0
    container_name: backup_${PROJECT_NAME}
    restart: always
    depends_on:
      - tunnel
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      # 关键点：这里连接的是 tunnel 服务的容器名
      MASTER_HOST: tunnel
      MASTER_PORT: 3306
      MASTER_USER: ${MASTER_USER}
      MASTER_PASSWORD: ${MASTER_PASSWORD}
    ports:
      - "${LOCAL_PORT}:3306"
    volumes:
      - ./data:/var/lib/mysql
      - ./init-slave.sh:/docker-entrypoint-initdb.d/init-slave.sh
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1G

  # === 服务3: phpMyAdmin (可视化管理) ===
  pma:
    image: phpmyadmin/phpmyadmin
    container_name: pma_${PROJECT_NAME}
    restart: always
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
    ports:
      - "${PMA_PORT}:80"
    depends_on:
      - db
